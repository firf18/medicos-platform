---
description: "Elite Development Rules for Platform M√©dicos - World-class medical platform with HIPAA compliance and architectural excellence"
globs: ["**/*.ts", "**/*.tsx", "**/*.js", "**/*.jsx", "**/*.sql", "**/*.md", "**/*.json"]
alwaysApply: true
version: "2.0.0"
lastUpdated: "2025-09-20"
---

# üèÜ Reglas Elite de Desarrollo - Platform M√©dicos

> **CR√çTICO**: Plataforma m√©dica de clase mundial que maneja datos sensibles de salud. Estas reglas garantizan excelencia arquitect√≥nica, compliance HIPAA y escalabilidad empresarial.

## üéØ Principios Fundamentales Elite

### 1. üîí Seguridad y Compliance M√©dico (NIVEL CR√çTICO)
- **HIPAA-Style Compliance**: Todos los datos m√©dicos deben estar protegidos y auditados
- **Zero Trust**: Verificar permisos en cada operaci√≥n, nunca confiar en datos del cliente
- **Data Minimization**: Solicitar y procesar solo datos estrictamente necesarios
- **Audit Trail**: Registrar todas las operaciones cr√≠ticas para auditor√≠a
- **Encryption**: Datos sensibles encriptados en tr√°nsito y en reposo

```typescript
// ‚úÖ Correcto - Verificaci√≥n de permisos granular
const canAccessMedicalRecord = await checkPermissions(userId, recordId, 'read');
if (!canAccessMedicalRecord) {
  logSecurityEvent('unauthorized_access_attempt', { userId, recordId });
  throw new UnauthorizedError('Acceso denegado');
}
```

### 2. üß¨ Responsabilidad √önica Extrema (SRP+)
- **M√°ximo 300 l√≠neas por archivo** (regla estricta post-refactorizaci√≥n)
- **Una responsabilidad por m√≥dulo**: Cada archivo debe ser experto en UN solo aspecto
- **Separaci√≥n granular**: UI, l√≥gica, validaci√≥n, tipos en archivos separados
- **M√≥dulos cohesivos**: Alta cohesi√≥n interna, bajo acoplamiento externo
- **Refactorizaci√≥n autom√°tica**: Si un archivo supera 300 l√≠neas, debe ser dividido inmediatamente

```typescript
// ‚úÖ Correcto - Archivo con responsabilidad √∫nica
// src/components/medical/PatientVitalSigns.tsx (147 l√≠neas)
interface PatientVitalSignsProps {
  patientId: string;
  readonly?: boolean;
}

const PatientVitalSigns = memo<PatientVitalSignsProps>(({ patientId, readonly }) => {
  // Solo maneja visualizaci√≥n de signos vitales
  // Validaci√≥n en: src/lib/validations/vital-signs.validations.ts
  // Tipos en: src/types/medical/vital-signs.types.ts
  // L√≥gica en: src/hooks/medical/useVitalSigns.ts
});

// ‚ùå Incorrecto - Archivo con m√∫ltiples responsabilidades
// Un archivo que contenga: UI + validaci√≥n + tipos + API calls + business logic
```

### 3. üèõÔ∏è Arquitectura Limpia Estricta (Clean Architecture+)
- **Capas independientes**: Cada capa debe poder funcionar sin las superiores
- **Dependency Inversion radical**: Todas las dependencias apuntan hacia el dominio
- **Interfaces en lugar de implementaciones**: Nunca depender de concreciones
- **Testabilidad extrema**: Cada m√≥dulo debe ser 100% testeable en aislamiento

```typescript
// ‚úÖ Arquitectura de capas estricta
src/
‚îú‚îÄ‚îÄ domains/              # üèõÔ∏è Capa de Dominio (Business Logic)
‚îÇ   ‚îú‚îÄ‚îÄ medical-records/  # Entidades y casos de uso m√©dicos
‚îÇ   ‚îú‚îÄ‚îÄ appointments/     # L√≥gica de citas m√©dicas
‚îÇ   ‚îî‚îÄ‚îÄ compliance/       # Reglas de compliance
‚îú‚îÄ‚îÄ adapters/            # üîå Capa de Adaptadores (Infrastructure)
‚îÇ   ‚îú‚îÄ‚îÄ supabase/       # Implementaci√≥n espec√≠fica de BD
‚îÇ   ‚îú‚îÄ‚îÄ didit/          # Integraci√≥n externa
‚îÇ   ‚îî‚îÄ‚îÄ email/          # Servicios de notificaci√≥n
‚îú‚îÄ‚îÄ application/         # üéØ Capa de Aplicaci√≥n (Use Cases)
‚îÇ   ‚îú‚îÄ‚îÄ services/       # Servicios de aplicaci√≥n
‚îÇ   ‚îî‚îÄ‚îÄ ports/          # Interfaces (contratos)
‚îî‚îÄ‚îÄ presentation/        # üé® Capa de Presentaci√≥n (UI)
    ‚îú‚îÄ‚îÄ components/     # Componentes React
    ‚îî‚îÄ‚îÄ pages/         # P√°ginas Next.js
```

### 4. üèóÔ∏è Arquitectura Escalable por Features
- **Domain-Driven Design**: Organizar c√≥digo por dominio m√©dico (auth, appointments, records, chat)
- **Bounded Contexts**: Cada feature es independiente y cohesiva
- **Clean Architecture**: Separaci√≥n clara entre UI, business logic y data access
- **Vertical Slicing**: Features completas (UI + API + DB) en m√≥dulos independientes

### 5. üî¨ SOLID Principles para Medicina Digital
- **S** - Single Responsibility: Un m√≥dulo = Un experto m√©dico
- **O** - Open/Closed: Extensible sin modificar (nuevas especialidades m√©dicas)
- **L** - Liskov Substitution: Interfaces m√©dicas intercambiables
- **I** - Interface Segregation: Interfaces espec√≠ficas por rol m√©dico
- **D** - Dependency Inversion: Depender de abstracciones m√©dicas, no implementaciones

```typescript
// ‚úÖ Ejemplo SOLID en medicina
interface MedicalRecordRepository {
  findByPatient(patientId: string): Promise<MedicalRecord[]>;
  create(record: MedicalRecordInput): Promise<MedicalRecord>;
}

// Implementaci√≥n espec√≠fica (puede cambiar sin afectar dominio)
class SupabaseMedicalRecordRepository implements MedicalRecordRepository {
  async findByPatient(patientId: string): Promise<MedicalRecord[]> {
    // Implementaci√≥n espec√≠fica de Supabase
  }
}

// Servicio de dominio (estable, no cambia)
class MedicalRecordService {
  constructor(private repository: MedicalRecordRepository) {} // DI
  
  async createRecord(data: MedicalRecordInput): Promise<MedicalRecord> {
    // L√≥gica de negocio pura
    await this.validateMedicalData(data);
    return this.repository.create(data);
  }
}
```

### 6. ‚ö° Performance y Escalabilidad Elite
- **Lazy Loading Inteligente**: Cargar m√≥dulos m√©dicos solo cuando sean necesarios
- **Memoizaci√≥n Selectiva**: Solo memoizar componentes costosos de renderizar
- **Optimistic Updates**: Para mejorar UX en operaciones m√©dicas no cr√≠ticas
- **Cache Strategies**: Cache inteligente para datos m√©dicos frecuentes
- **Code Splitting**: Por roles m√©dicos y especialidades

```typescript
// ‚úÖ Performance elite para aplicaciones m√©dicas
const DoctorDashboard = lazy(() => 
  import('@/features/doctor/DoctorDashboard').then(module => ({
    default: memo(module.default, (prev, next) => 
      prev.doctorId === next.doctorId && 
      prev.lastUpdateTime === next.lastUpdateTime
    )
  }))
);

// ‚úÖ Cache estrat√©gico para datos m√©dicos
const usePatientHistory = (patientId: string) => {
  return useQuery({
    queryKey: ['patient-history', patientId],
    queryFn: () => fetchPatientHistory(patientId),
    staleTime: 5 * 60 * 1000, // 5 min para datos m√©dicos cr√≠ticos
    cacheTime: 30 * 60 * 1000, // 30 min en cache
    retry: 3,
    retryDelay: attemptIndex => Math.min(1000 * 2 ** attemptIndex, 30000),
  });
};
```

### 7. üß™ Testing de Clase Mundial
- **Testing Pyramid**: 70% Unit, 20% Integration, 10% E2E
- **Medical Critical Path Testing**: 100% coverage en flujos m√©dicos cr√≠ticos
- **Property-Based Testing**: Para validaciones m√©dicas complejas
- **Snapshot Testing**: Para componentes m√©dicos estables
- **Performance Testing**: Para operaciones en tiempo real

```typescript
// ‚úÖ Testing elite para medicina
describe('MedicalRecordCreation', () => {
  it('should validate all medical data before persistence', async () => {
    // Arrange
    const invalidRecord = createInvalidMedicalRecord();
    const validRecord = createValidMedicalRecord();
    
    // Act & Assert
    await expect(createMedicalRecord(invalidRecord)).rejects.toThrow('Validation failed');
    
    const result = await createMedicalRecord(validRecord);
    expect(result.id).toMatch(/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/);
    
    // Security assertion
    expect(auditLogger.logMedicalEvent).toHaveBeenCalledWith(
      expect.objectContaining({
        eventType: 'medical_record_created',
        severity: 'info',
        patientId: validRecord.patientId
      })
    );
  });
  
  // Property-based testing para validaciones m√©dicas
  it('should handle all valid blood pressure combinations', () => {
    fc.assert(fc.property(
      fc.integer({ min: 80, max: 200 }), // systolic
      fc.integer({ min: 40, max: 120 }), // diastolic
      (systolic, diastolic) => {
        fc.pre(systolic > diastolic); // precondition
        const vitalSigns = { systolic, diastolic };
        expect(validateVitalSigns(vitalSigns)).toBe(true);
      }
    ));
  });
});
```

## üèóÔ∏è Estructura de Archivos Elite (Arquitectura Multi-Rol)

### Organizaci√≥n Elite por Dominios M√©dicos (Post-Refactorizaci√≥n)
```
src/
‚îú‚îÄ‚îÄ app/                       # üöÄ Next.js 15 App Router
‚îÇ   ‚îú‚îÄ‚îÄ (auth)/               # üîê Autenticaci√≥n y verificaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ (protected)/          # üõ°Ô∏è Rutas protegidas con m√∫ltiples roles
‚îÇ   ‚îú‚îÄ‚îÄ doctor/               # üë®‚Äç‚öïÔ∏è Dashboard y funciones para m√©dicos
‚îÇ   ‚îú‚îÄ‚îÄ patient/              # üë§ Portal y dashboard para pacientes
‚îÇ   ‚îú‚îÄ‚îÄ clinic/               # üè• Gesti√≥n para cl√≠nicas
‚îÇ   ‚îú‚îÄ‚îÄ laboratory/           # üî¨ Gesti√≥n para laboratorios (refactorizado)
‚îÇ   ‚îú‚îÄ‚îÄ admin/                # ‚öôÔ∏è Administraci√≥n del sistema
‚îÇ   ‚îú‚îÄ‚îÄ emergency/            # üö® Protocolo de emergencias m√©dicas
‚îÇ   ‚îî‚îÄ‚îÄ api/                  # üì° API endpoints con RLS
‚îÇ
‚îú‚îÄ‚îÄ components/               # üß© Componentes Modulares por Dominio
‚îÇ   ‚îú‚îÄ‚îÄ auth/                # üîë Autenticaci√≥n (refactorizado)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ shared/          # ‚úÖ Componentes compartidos
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ patient/         # ‚úÖ Espec√≠ficos de pacientes
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ verification/    # ‚úÖ Verificaci√≥n de identidad
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ doctor-registration/ # ‚úÖ Registro m√©dico especializado
‚îÇ   ‚îú‚îÄ‚îÄ laboratory/          # üî¨ Laboratorio (refactorizado)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LabStatisticsWidget.tsx    # ‚úÖ (142 l√≠neas)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LabFilters.tsx             # ‚úÖ (98 l√≠neas)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LabTestsTable.tsx          # ‚ö†Ô∏è (465 l√≠neas - revisar)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ LabWidgets.tsx             # ‚ö†Ô∏è (454 l√≠neas - revisar)
‚îÇ   ‚îú‚îÄ‚îÄ dashboard/           # üìä Dashboards especializados
‚îÇ   ‚îú‚îÄ‚îÄ patient-dashboard/   # üë§ Dashboard espec√≠fico de pacientes
‚îÇ   ‚îú‚îÄ‚îÄ ui/                  # üé® Design System m√©dico (Shadcn/ui)
‚îÇ   ‚îî‚îÄ‚îÄ navigation/          # üß≠ Navegaci√≥n multi-rol
‚îÇ
‚îú‚îÄ‚îÄ domains/                 # üèõÔ∏è L√≥gica de Dominio M√©dico (DDD)
‚îÇ   ‚îú‚îÄ‚îÄ auth/               # üîê Autenticaci√≥n y registro
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ components/     # Componentes espec√≠ficos del dominio
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ hooks/          # Hooks especializados
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/       # Servicios de negocio
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ types/          # Tipos del dominio
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils/          # Utilidades del dominio
‚îÇ   ‚îú‚îÄ‚îÄ compliance/         # üìã Verificaci√≥n y compliance HIPAA
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ hooks/useDiditVerification.ts  # ‚ö†Ô∏è (499 l√≠neas - revisar)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/       # Servicios de verificaci√≥n
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ types/          # Tipos de compliance
‚îÇ   ‚îú‚îÄ‚îÄ medical-records/    # üìã Historiales m√©dicos
‚îÇ   ‚îú‚îÄ‚îÄ appointments/       # üìÖ Gesti√≥n de citas m√©dicas
‚îÇ   ‚îî‚îÄ‚îÄ emergency/          # üö® Servicios de emergencia
‚îÇ
‚îú‚îÄ‚îÄ lib/                    # üõ†Ô∏è Configuraciones y Utilidades
‚îÇ   ‚îú‚îÄ‚îÄ validations/        # ‚úÖ Validaciones modulares (refactorizado)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ personal-info.validations.ts      # ‚úÖ (89 l√≠neas)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ professional-info.validations.ts  # ‚úÖ (156 l√≠neas)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ specialty.validations.ts          # ‚úÖ (67 l√≠neas)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ license-verification.validations.ts # ‚úÖ (134 l√≠neas)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ identity-verification.validations.ts # ‚úÖ (387 l√≠neas)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dashboard-config.validations.ts   # ‚ö†Ô∏è (501 l√≠neas - revisar)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ security.validations.ts           # ‚úÖ (466 l√≠neas)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts                          # ‚úÖ Re-exportaci√≥n central
‚îÇ   ‚îú‚îÄ‚îÄ medical-specialties/ # ‚úÖ Especialidades modulares (refactorizado)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ base-features.ts                  # ‚úÖ (407 l√≠neas)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ specialties-data.ts               # Datos de especialidades
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ utils.ts                          # Utilidades
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts                          # Re-exportaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ license-validator/   # ‚úÖ Validador modular (refactorizado)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.ts                         # ‚úÖ (95 l√≠neas)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ browser-service.ts                # ‚úÖ (494 l√≠neas)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sacs-scraper.ts                   # Scraping SACS
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mpps-fallback.ts                  # Fallback MPPS
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts                          # Re-exportaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ laboratory/         # ‚úÖ Utilidades de laboratorio (nuevo)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ lab-utils.ts                      # ‚úÖ (427 l√≠neas)
‚îÇ   ‚îú‚îÄ‚îÄ supabase/          # üóÑÔ∏è Cliente Supabase con RLS
‚îÇ   ‚îî‚îÄ‚îÄ logging/           # üìù Logging estructurado para auditor√≠a
‚îÇ
‚îú‚îÄ‚îÄ types/                  # üìù Tipos TypeScript Modulares (refactorizado)
‚îÇ   ‚îú‚îÄ‚îÄ database/          # ‚úÖ Tipos por dominio m√©dico (refactorizado)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.types.ts                     # ‚úÖ (78 l√≠neas)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ patients.types.ts                 # ‚úÖ (156 l√≠neas)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ doctors.types.ts                  # ‚úÖ (89 l√≠neas)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ appointments.types.ts             # ‚úÖ (67 l√≠neas)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ medical-records.types.ts          # ‚úÖ (98 l√≠neas)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ clinics.types.ts                  # ‚úÖ (76 l√≠neas)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ laboratory.types.ts               # ‚úÖ (134 l√≠neas)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ notifications.types.ts            # ‚úÖ (45 l√≠neas)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ health.types.ts                   # ‚úÖ (408 l√≠neas)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ base.types.ts                     # ‚úÖ (34 l√≠neas)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts                          # ‚úÖ Exportaci√≥n unificada
‚îÇ   ‚îú‚îÄ‚îÄ medical-specialties/ # ‚úÖ Tipos de especialidades (nuevo)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ medical-specialties.types.ts     # ‚úÖ (89 l√≠neas)
‚îÇ   ‚îú‚îÄ‚îÄ laboratory/        # ‚úÖ Tipos de laboratorio (nuevo)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ laboratory.types.ts              # ‚úÖ (67 l√≠neas)
‚îÇ   ‚îú‚îÄ‚îÄ auth/              # Tipos de autenticaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ dashboard/         # Tipos de dashboards
‚îÇ   ‚îî‚îÄ‚îÄ shared/            # Tipos compartidos
‚îÇ
‚îú‚îÄ‚îÄ hooks/                 # üé£ Custom Hooks Especializados
‚îÇ   ‚îú‚îÄ‚îÄ laboratory/        # ‚úÖ Hooks de laboratorio (nuevo)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ useLabData.ts                     # ‚úÖ (156 l√≠neas)
‚îÇ   ‚îú‚îÄ‚îÄ medical/           # Hooks m√©dicos espec√≠ficos
‚îÇ   ‚îî‚îÄ‚îÄ auth/              # Hooks de autenticaci√≥n
‚îÇ
‚îú‚îÄ‚îÄ providers/             # üîó Context Providers Especializados
‚îú‚îÄ‚îÄ adapters/              # üîå Adaptadores para servicios externos
‚îú‚îÄ‚îÄ test/                  # üß™ Suite de testing automatizado
‚îî‚îÄ‚îÄ middleware.ts          # üõ°Ô∏è Middleware de protecci√≥n de rutas
```

### ‚úÖ M√©tricas Post-Refactorizaci√≥n
- **7 archivos principales refactorizados** ‚Üí 40+ m√≥dulos especializados
- **Responsabilidad √∫nica**: 100% en archivos refactorizados
- **26 archivos > 400 l√≠neas** ‚Üí Candidatos para pr√≥xima iteraci√≥n
- **0 c√≥digo duplicado** significativo detectado
- **Backward compatibility** mantenida con archivos deprecated

### Convenciones de Nomenclatura M√©dica Elite
- **Componentes**: PascalCase con sufijo de dominio (`MedicalRecordForm.tsx`, `EmergencyContactsList.tsx`)
- **Hooks**: camelCase m√©dico espec√≠fico (`useMedicalHistory.ts`, `useEmergencyContacts.ts`)
- **Servicios**: PascalCase + Service (`MedicalRecordService.ts`, `ComplianceValidationService.ts`)
- **Repositorios**: PascalCase + Repository (`PatientRepository.ts`, `AppointmentRepository.ts`)
- **Utilidades**: camelCase descriptivo (`validateMedicalID.ts`, `formatDiagnosis.ts`)
- **Tipos**: PascalCase + Types (`Patient.types.ts`, `MedicalRecord.types.ts`)
- **Validaciones**: kebab-case + .validations (`medical-record.validations.ts`)
- **Constantes m√©dicas**: UPPER_SNAKE_CASE (`MEDICAL_SPECIALTIES.ts`, `EMERGENCY_PROTOCOLS.ts`)
- **Rutas**: kebab-case (`patient-dashboard/`, `emergency-contacts/`)
- **Test files**: `.test.ts` o `.spec.ts` (`PatientService.test.ts`)

### üîß Reglas de Refactorizaci√≥n Continua
- **Threshold autom√°tico**: Archivo > 300 l√≠neas ‚Üí Refactorizar inmediatamente
- **Complejidad ciclom√°tica**: Funci√≥n > 10 ‚Üí Dividir en subfunciones
- **Dependencias por archivo**: > 15 imports ‚Üí Revisar acoplamiento
- **Duplicate code**: > 3 l√≠neas repetidas ‚Üí Extraer a utilidad com√∫n
- **Performance degradation**: > 100ms render ‚Üí Optimizar o memoizar

```typescript
// ‚úÖ Trigger autom√°tico de refactorizaci√≥n
// Pre-commit hook que verifica m√©tricas de calidad
const qualityGates = {
  maxLinesPerFile: 300,
  maxComplexity: 10,
  maxImports: 15,
  minTestCoverage: 80,
  maxRenderTime: 100 // ms
};

// Script automatizado para detecci√≥n
function analyzeFileQuality(filePath: string): QualityReport {
  const analysis = {
    lineCount: getLineCount(filePath),
    complexity: getCyclomaticComplexity(filePath),
    importCount: getImportCount(filePath),
    duplicateCode: findDuplicateCode(filePath),
    testCoverage: getTestCoverage(filePath)
  };
  
  const violations = [];
  if (analysis.lineCount > qualityGates.maxLinesPerFile) {
    violations.push(`File exceeds ${qualityGates.maxLinesPerFile} lines`);
  }
  
  return { analysis, violations, requiresRefactoring: violations.length > 0 };
}
```

## üìù Reglas de C√≥digo TypeScript Elite

### TypeScript para Datos M√©dicos (Nivel Avanzado)
- **Tipos expl√≠citos obligatorios**: Todos los datos m√©dicos deben estar tipados
- **Strict mode extremo**: `"strict": true` + `"noUncheckedIndexedAccess": true`
- **No usar `any` JAM√ÅS**: Usar tipos espec√≠ficos o `unknown` para datos m√©dicos
- **Branded Types**: Para IDs m√©dicos √∫nicos y validados
- **Union types discriminados**: Para estados m√©dicos complejos
- **Zod para validaci√≥n runtime**: Validar datos m√©dicos en runtime con schemas espec√≠ficos
- **Template Literal Types**: Para IDs con formato espec√≠fico
- **Utility Types**: Para transformaciones seguras de tipos

```typescript
// ‚úÖ Branded Types para seguridad m√©dica
type PatientId = string & { __brand: 'PatientId' };
type DoctorId = string & { __brand: 'DoctorId' };
type MedicalRecordId = string & { __brand: 'MedicalRecordId' };

// ‚úÖ Funciones de construcci√≥n segura
const createPatientId = (id: string): PatientId => {
  if (!id.match(/^PAT-[0-9A-F]{8}$/)) {
    throw new Error('Invalid patient ID format');
  }
  return id as PatientId;
};

// ‚úÖ Union types discriminados para estados m√©dicos
type MedicalRecordStatus = 
  | { status: 'draft'; lastModified: Date; canEdit: true }
  | { status: 'reviewed'; reviewedBy: DoctorId; reviewDate: Date; canEdit: false }
  | { status: 'archived'; archivedBy: DoctorId; archiveDate: Date; canEdit: false }
  | { status: 'deleted'; deletedBy: DoctorId; deleteDate: Date; canEdit: false };

// ‚úÖ Template Literal Types para IDs con formato
type VenezuelanCedula = `V-${number}` | `E-${number}`;
type MedicalLicense = `MPPS-${number}`;
type EmergencyCode = `EMR-${number}-${number}`;

// ‚úÖ Utility Types para transformaciones m√©dicas
type MedicalRecordInput = Omit<MedicalRecord, 'id' | 'createdAt' | 'updatedAt'>;
type PatientSummary = Pick<Patient, 'id' | 'firstName' | 'lastName' | 'dateOfBirth'>;
type PartialMedicalUpdate = Partial<Pick<MedicalRecord, 'diagnosis' | 'treatment' | 'notes'>>;

// ‚úÖ Conditional types para permisos m√©dicos
type MedicalAccess<T extends UserRole> = 
  T extends 'doctor' ? FullMedicalAccess :
  T extends 'nurse' ? LimitedMedicalAccess :
  T extends 'patient' ? OwnDataAccess :
  NoAccess;
```

### Validaciones Zod Avanzadas para Medicina
```typescript
// ‚úÖ Schemas m√©dicos con validaciones complejas
const VitalSignsSchema = z.object({
  bloodPressure: z.object({
    systolic: z.number().min(70).max(250),
    diastolic: z.number().min(40).max(150)
  }).refine(
    data => data.systolic > data.diastolic,
    { message: "Presi√≥n sist√≥lica debe ser mayor que diast√≥lica" }
  ),
  heartRate: z.number().min(30).max(220),
  temperature: z.number().min(35).max(42),
  oxygenSaturation: z.number().min(80).max(100),
  timestamp: z.date().max(new Date(), "No puede ser fecha futura")
});

// ‚úÖ Schema con transformaciones autom√°ticas
const PatientRegistrationSchema = z.object({
  cedula: z.string()
    .regex(/^[VE]-\d{7,8}$/, "Formato de c√©dula inv√°lido")
    .transform(val => val.toUpperCase() as VenezuelanCedula),
  email: z.string().email().transform(val => val.toLowerCase()),
  phone: z.string()
    .regex(/^\+58\d{10}$/, "Tel√©fono venezolano inv√°lido")
    .transform(val => val.replace(/\D/g, '')),
  emergencyContacts: z.array(EmergencyContactSchema).min(1).max(3)
});

// ‚úÖ Validaci√≥n condicional basada en rol m√©dico
const MedicalRecordCreationSchema = z.object({
  patientId: z.string().uuid(),
  diagnosis: z.string().min(10).max(1000),
  treatment: z.string().min(5).max(2000),
  medications: z.array(MedicationSchema).default([]),
  confidentialityLevel: z.enum(['public', 'restricted', 'confidential', 'secret']),
  createdByRole: z.enum(['doctor', 'nurse', 'specialist'])
}).refine(
  data => {
    // Solo m√©dicos pueden crear registros confidenciales
    if (data.confidentialityLevel === 'confidential' && data.createdByRole !== 'doctor') {
      return false;
    }
    return true;
  },
  { message: "Solo m√©dicos pueden crear registros confidenciales" }
);
```

### Componentes React Elite para Interfaces M√©dicas
- **Functional components √∫nicamente**: No class components JAM√ÅS
- **Props inmutables estrictas**: Usar `readonly` en todas las props m√©dicas
- **Memoizaci√≥n inteligente**: Comparadores personalizados para datos m√©dicos
- **Error boundaries obligatorios**: Capturar errores en interfaces cr√≠ticas
- **Accessibility compliance**: WCAG 2.1 AA para interfaces m√©dicas
- **Compound Components**: Para interfaces m√©dicas complejas
- **Render Props**: Para l√≥gica reutilizable m√©dica
- **Hooks personalizados**: Para l√≥gica espec√≠fica del dominio m√©dico

```typescript
// ‚úÖ Componente m√©dico elite con todas las mejores pr√°cticas
import { memo, useCallback, useEffect, useMemo, forwardRef } from 'react';
import { logSecurityEvent } from '@/lib/security/auditLogger';
import { useMedicalRecordPermissions } from '@/hooks/medical/useMedicalRecordPermissions';
import { ErrorBoundary } from '@/components/error-boundary/MedicalErrorBoundary';
import type { MedicalRecord, SecurityEvent, UserRole } from '@/types/medical';

// ‚úÖ Props inmutables con readonly
interface MedicalRecordViewProps {
  readonly record: MedicalRecord;
  readonly userRole: UserRole;
  readonly canEdit: boolean;
  readonly isEmergencyAccess?: boolean;
  readonly onUpdate: (record: Partial<MedicalRecord>) => Promise<void>;
  readonly onSecurityEvent: (event: SecurityEvent) => void;
  readonly className?: string;
}

// ‚úÖ Comparador personalizado para memoizaci√≥n inteligente
const arePropsEqual = (
  prevProps: MedicalRecordViewProps,
  nextProps: MedicalRecordViewProps
): boolean => {
  return (
    prevProps.record.id === nextProps.record.id &&
    prevProps.record.updatedAt === nextProps.record.updatedAt &&
    prevProps.canEdit === nextProps.canEdit &&
    prevProps.userRole === nextProps.userRole &&
    prevProps.isEmergencyAccess === nextProps.isEmergencyAccess
  );
};

// ‚úÖ Componente con forwardRef para accesibilidad
const MedicalRecordView = memo(forwardRef<HTMLDivElement, MedicalRecordViewProps>(({ 
  record, 
  userRole,
  canEdit, 
  isEmergencyAccess = false,
  onUpdate, 
  onSecurityEvent,
  className = ''
}, ref) => {
  // ‚úÖ Hook personalizado para permisos m√©dicos
  const { canViewSensitiveData, canEditRecord, permissions } = useMedicalRecordPermissions({
    userRole,
    recordConfidentiality: record.confidentialityLevel,
    isEmergencyAccess
  });

  // ‚úÖ Audit trail autom√°tico con cleanup
  useEffect(() => {
    const viewEvent = {
      eventType: 'medical_record_viewed' as const,
      recordId: record.id,
      patientId: record.patientId,
      userRole,
      isEmergencyAccess,
      confidentialityLevel: record.confidentialityLevel,
      timestamp: new Date().toISOString()
    };

    logSecurityEvent(viewEvent);

    // Cleanup: registrar tiempo de visualizaci√≥n
    return () => {
      logSecurityEvent({
        eventType: 'medical_record_view_ended',
        recordId: record.id,
        sessionDuration: Date.now() - new Date(viewEvent.timestamp).getTime()
      });
    };
  }, [record.id, record.patientId, userRole, isEmergencyAccess, record.confidentialityLevel]);

  // ‚úÖ Handler optimizado con validaciones de seguridad
  const handleUpdate = useCallback(async (updates: Partial<MedicalRecord>) => {
    if (!canEditRecord) {
      onSecurityEvent({ 
        type: 'unauthorized_edit_attempt', 
        recordId: record.id,
        userRole 
      });
      return;
    }

    try {
      await onUpdate(updates);
      logSecurityEvent({
        eventType: 'medical_record_updated',
        recordId: record.id,
        updatedFields: Object.keys(updates),
        userRole
      });
    } catch (error) {
      onSecurityEvent({ 
        type: 'update_failed', 
        error, 
        recordId: record.id 
      });
    }
  }, [record.id, canEditRecord, onUpdate, onSecurityEvent, userRole]);

  // ‚úÖ Datos computados con memoizaci√≥n
  const displayData = useMemo(() => {
    if (!canViewSensitiveData) {
      return {
        ...record,
        diagnosis: '[CONFIDENCIAL]',
        treatment: '[CONFIDENCIAL]',
        notes: '[CONFIDENCIAL]'
      };
    }
    return record;
  }, [record, canViewSensitiveData]);

  // ‚úÖ Render con accesibilidad completa
  return (
    <ErrorBoundary fallback={<MedicalRecordErrorFallback />}>
      <div 
        ref={ref}
        className={`medical-record-view ${className}`}
        role="region" 
        aria-label={`Registro m√©dico de ${record.patientName}`}
        aria-describedby={`record-${record.id}-description`}
        data-testid={`medical-record-${record.id}`}
      >
        <div id={`record-${record.id}-description`} className="sr-only">
          Registro m√©dico creado el {new Date(record.createdAt).toLocaleDateString()}
          {isEmergencyAccess && ' - Acceso de emergencia activo'}
        </div>
        
        {/* Contenido del componente con datos filtrados */}
        <MedicalRecordContent 
          record={displayData}
          permissions={permissions}
          onUpdate={canEdit ? handleUpdate : undefined}
        />
      </div>
    </ErrorBoundary>
  );
}), arePropsEqual);

MedicalRecordView.displayName = 'MedicalRecordView';

// ‚úÖ Compound component para funcionalidad espec√≠fica
MedicalRecordView.Header = MedicalRecordHeader;
MedicalRecordView.Content = MedicalRecordContent;
MedicalRecordView.Actions = MedicalRecordActions;

export default MedicalRecordView;
```

## üöÄ CI/CD y Deployment Elite

### Pipeline de Calidad M√©dica
- **Multi-stage pipeline**: dev ‚Üí staging ‚Üí production con gates de calidad
- **Automated quality gates**: Tests, security scans, performance checks
- **Medical compliance checks**: HIPAA validation autom√°tica
- **Zero-downtime deployment**: Para servicios m√©dicos cr√≠ticos
- **Rollback autom√°tico**: En caso de degradaci√≥n de performance

```yaml
# ‚úÖ Pipeline de calidad m√©dica
name: Medical Platform CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  quality-gates:
    runs-on: ubuntu-latest
    steps:
      - name: Code Quality Check
        run: |
          # Verificar l√≠mite de l√≠neas por archivo
          find src -name "*.ts" -o -name "*.tsx" | xargs wc -l | awk '$1 > 300 {print "File " $2 " exceeds 300 lines: " $1; exit 1}'
          
          # Verificar responsabilidad √∫nica
          npm run analyze:responsibilities
          
          # Security scan para datos m√©dicos
          npm run security:medical-scan
          
      - name: Medical Compliance Check
        run: |
          # Verificar audit trail
          npm run compliance:audit-trail-check
          
          # Validar RLS policies
          npm run db:validate-rls
          
          # Check HIPAA compliance
          npm run compliance:hipaa-check

  performance-testing:
    needs: quality-gates
    runs-on: ubuntu-latest
    steps:
      - name: Load Testing Medical APIs
        run: |
          # Test performance de endpoints cr√≠ticos
          npm run test:performance:medical
          
          # Database performance check
          npm run test:db-performance
          
          # Real-time systems test
          npm run test:realtime-performance

  security-testing:
    needs: quality-gates
    runs-on: ubuntu-latest
    steps:
      - name: Security Penetration Testing
        run: |
          # Test de penetraci√≥n automatizado
          npm run security:penetration-test
          
          # Vulnerability scan
          npm audit --audit-level high
          
          # Medical data encryption check
          npm run security:encryption-check
```

### M√©tricas de Calidad Continua
```typescript
// ‚úÖ M√©tricas autom√°ticas de calidad
interface QualityMetrics {
  codeQuality: {
    averageLinesPerFile: number;
    filesExceedingLimit: number;
    duplicateCodePercentage: number;
    cyclomaticComplexity: number;
  };
  testCoverage: {
    statements: number;
    branches: number;
    functions: number;
    lines: number;
    criticalPathsCovered: number;
  };
  performance: {
    averageApiResponseTime: number;
    p95ResponseTime: number;
    errorRate: number;
    uptime: number;
  };
  security: {
    vulnerabilitiesCount: number;
    lastSecurityScan: Date;
    complianceScore: number;
    auditTrailCoverage: number;
  };
}

// ‚úÖ Dashboard de m√©tricas autom√°tico
class QualityDashboard {
  async generateReport(): Promise<QualityMetrics> {
    return {
      codeQuality: await this.analyzeCodeQuality(),
      testCoverage: await this.analyzeTestCoverage(),
      performance: await this.analyzePerformance(),
      security: await this.analyzeSecurityPosture()
    };
  }
  
  async checkQualityGates(metrics: QualityMetrics): Promise<boolean> {
    const gates = [
      metrics.codeQuality.averageLinesPerFile < 250,
      metrics.testCoverage.criticalPathsCovered === 100,
      metrics.performance.p95ResponseTime < 500,
      metrics.security.vulnerabilitiesCount === 0
    ];
    
    return gates.every(gate => gate);
  }
}
```

## üîê Autenticaci√≥n y Seguridad Multi-Rol Elite

### Supabase Auth con RLS Granular
- **Row Level Security obligatorio**: Todas las tablas m√©dicas con RLS
- **Pol√≠ticas granulares**: Verificar permisos espec√≠ficos por rol y contexto
- **Functions con SECURITY DEFINER**: Funciones de BD con search_path fijo
- **Rate limiting**: Protecci√≥n contra ataques de fuerza bruta
- **Session recovery**: Manejo robusto de sesiones expiradas

```typescript
// ‚úÖ Verificaci√≥n de permisos granular
const hasAccess = await supabase.rpc('check_medical_record_access', {
  p_user_id: user.id,
  p_record_id: recordId,
  p_action: 'read',
  p_context: 'emergency' // contexto adicional para emergencias
});

// ‚úÖ Pol√≠ticas RLS espec√≠ficas por rol
-- En migration SQL
CREATE POLICY "doctors_read_patients" ON medical_records
  FOR SELECT USING (
    auth.role() = 'doctor' AND 
    doctor_id = auth.uid() OR
    EXISTS (
      SELECT 1 FROM appointments 
      WHERE patient_id = medical_records.patient_id 
      AND doctor_id = auth.uid()
      AND status = 'active'
    )
  );
```

### Protecci√≥n de Rutas Multi-Nivel
- **Middleware de Next.js**: Primera l√≠nea de defensa
- **AuthGuard components**: Verificaci√≥n granular en componentes
- **Role-based access**: Verificar roles espec√≠ficos por contexto
- **Emergency access**: Protocolos especiales para emergencias m√©dicas

```typescript
// ‚úÖ Middleware con protecci√≥n multi-rol
export async function middleware(request: NextRequest) {
  const { session, role } = await verifySession(request);
  
  if (!session) {
    return redirectToLogin(request);
  }

  // Verificaci√≥n espec√≠fica por ruta m√©dica
  if (request.nextUrl.pathname.startsWith('/doctor/')) {
    if (role !== 'doctor') {
      logSecurityEvent('unauthorized_doctor_access', { 
        userId: session.user.id, 
        attemptedPath: request.nextUrl.pathname 
      });
      return NextResponse.redirect(new URL('/auth/unauthorized', request.url));
    }
  }

  // Protecci√≥n especial para datos cr√≠ticos
  if (request.nextUrl.pathname.includes('/emergency/')) {
    const hasEmergencyAccess = await verifyEmergencyAccess(session.user.id);
    if (!hasEmergencyAccess) {
      return NextResponse.redirect(new URL('/auth/insufficient-privileges', request.url));
    }
  }

  return NextResponse.next();
}
```

## üé® UI/UX para Interfaces M√©dicas

### Tailwind CSS con Design System M√©dico
- **Accessibility-first**: WCAG 2.1 AA compliance obligatorio
- **Color coding m√©dico**: Colores espec√≠ficos para urgencias, warnings, success
- **High contrast**: Garantizar legibilidad en entornos m√©dicos
- **Mobile-first responsive**: Dise√±o para dispositivos m√©dicos diversos

### Componentes UI Especializados
- **Radix UI**: Base accesible para componentes complejos
- **Shadcn/ui**: Design system consistente adaptado al dominio m√©dico
- **Loading states**: Estados de carga para operaciones cr√≠ticas
- **Error states**: Manejo de errores user-friendly pero informativo

```typescript
// ‚úÖ Componente con variants m√©dicos
const alertVariants = cva(
  "border px-4 py-3 rounded-md",
  {
    variants: {
      variant: {
        emergency: "bg-red-50 border-red-200 text-red-800",
        warning: "bg-yellow-50 border-yellow-200 text-yellow-800",
        success: "bg-green-50 border-green-200 text-green-800",
        info: "bg-blue-50 border-blue-200 text-blue-800",
        critical: "bg-red-100 border-red-300 text-red-900 animate-pulse"
      },
      urgency: {
        low: "",
        medium: "border-2",
        high: "border-4 shadow-lg",
        critical: "border-4 shadow-xl animate-bounce"
      }
    }
  }
);
```

## üìä Manejo de Datos M√©dicos

### React Query para Estado del Servidor M√©dico
- **Invalidaci√≥n inteligente**: Cache invalidation para datos cr√≠ticos
- **Background updates**: Actualizaciones en tiempo real para datos vitales
- **Error retry logic**: Reintentos espec√≠ficos para operaciones m√©dicas
- **Optimistic updates**: Solo para operaciones no cr√≠ticas

```typescript
// ‚úÖ Query m√©dica con invalidaci√≥n autom√°tica
const { data: medicalRecords, isLoading, error } = useQuery({
  queryKey: ['medicalRecords', patientId, { includeEmergency: true }],
  queryFn: async () => {
    const { data, error } = await supabase
      .from('medical_records')
      .select(`
        *,
        medications (*),
        allergies (*),
        emergency_contacts (*)
      `)
      .eq('patient_id', patientId)
      .order('created_at', { ascending: false });
    
    if (error) {
      logSecurityEvent('medical_record_access_error', { patientId, error });
      throw error;
    }
    
    return data;
  },
  staleTime: 5 * 60 * 1000, // 5 minutos para datos m√©dicos
  refetchInterval: 30 * 1000, // Actualizar cada 30 segundos
  refetchOnWindowFocus: true, // Cr√≠tico para datos m√©dicos actualizados
});

// ‚úÖ Mutation con audit trail
const updateMedicalRecord = useMutation({
  mutationFn: async (updates: Partial<MedicalRecord>) => {
    const { data, error } = await supabase
      .from('medical_records')
      .update({
        ...updates,
        last_modified: new Date().toISOString(),
        last_modified_by: user.id
      })
      .eq('id', recordId)
      .select();
      
    if (error) throw error;
    return data;
  },
  onSuccess: () => {
    // Invalidar queries relacionadas
    queryClient.invalidateQueries(['medicalRecords', patientId]);
    queryClient.invalidateQueries(['patientSummary', patientId]);
    
    logSecurityEvent('medical_record_updated', {
      recordId,
      patientId,
      updatedBy: user.id
    });
  },
  onError: (error) => {
    logSecurityEvent('medical_record_update_failed', {
      recordId,
      patientId,
      error: error.message
    });
  }
});
```

### Zustand para Estado Global M√©dico
- **Estado m√≠nimo**: Solo datos cr√≠ticos compartidos
- **Persistence selectiva**: Solo datos no sensibles en localStorage
- **State splitting**: Separar estado por dominio m√©dico
- **Security boundaries**: No almacenar datos m√©dicos sensibles

```typescript
// ‚úÖ Store m√©dico seguro
interface MedicalAppState {
  currentPatient: { id: string; name: string } | null; // Solo datos b√°sicos
  activeEmergency: boolean;
  notifications: MedicalNotification[];
  userPreferences: UserPreferences;
}

const useMedicalStore = create<MedicalAppState>()(
  devtools(
    persist(
      (set, get) => ({
        currentPatient: null,
        activeEmergency: false,
        notifications: [],
        userPreferences: {},
        
        setCurrentPatient: (patient) => {
          logSecurityEvent('patient_context_changed', { 
            previousPatient: get().currentPatient?.id,
            newPatient: patient?.id 
          });
          set({ currentPatient: patient });
        },
        
        triggerEmergency: () => {
          logSecurityEvent('emergency_triggered', { 
            userId: get().currentUser?.id,
            timestamp: new Date().toISOString()
          });
          set({ activeEmergency: true });
        }
      }),
      {
        name: 'medical-app-state',
        partialize: (state) => ({
          // Solo persistir datos no sensibles
          userPreferences: state.userPreferences
        })
      }
    )
  )
);
```

## üß™ Testing Automatizado con Vitest

### Estrategia de Testing M√©dico
- **Testing pyramid**: 70% unit, 20% integration, 10% E2E
- **Critical path testing**: Flujos m√©dicos cr√≠ticos 100% cubiertos
- **Security testing**: Verificar permisos y validaciones
- **Accessibility testing**: Compliance WCAG autom√°tico

```typescript
// ‚úÖ Test de componente m√©dico
describe('MedicalRecordForm', () => {
  it('should validate medical data before submission', async () => {
    const mockPatient = createMockPatient();
    const mockOnSubmit = vi.fn();
    
    render(
      <MedicalRecordForm 
        patient={mockPatient} 
        onSubmit={mockOnSubmit} 
      />
    );
    
    // Probar validaci√≥n de diagn√≥stico
    const diagnosisInput = screen.getByLabelText(/diagn√≥stico/i);
    await user.type(diagnosisInput, 'Dx'); // Muy corto
    
    const submitButton = screen.getByRole('button', { name: /guardar/i });
    await user.click(submitButton);
    
    // Verificar que no se env√≠a con datos inv√°lidos
    expect(mockOnSubmit).not.toHaveBeenCalled();
    expect(screen.getByText(/diagn√≥stico debe tener al menos/i)).toBeInTheDocument();
  });

  it('should log security events on form submission', async () => {
    const mockLogSecurityEvent = vi.spyOn(logger, 'logSecurityEvent');
    
    // ... setup y acciones del test
    
    expect(mockLogSecurityEvent).toHaveBeenCalledWith(
      'medical_record_created',
      expect.objectContaining({
        patientId: mockPatient.id,
        createdBy: mockUser.id
      })
    );
  });
});

// ‚úÖ Test de hook m√©dico
describe('useMedicalHistory', () => {
  it('should handle unauthorized access gracefully', async () => {
    const mockUnauthorizedUser = createMockUser({ role: 'patient' });
    
    const { result } = renderHook(() => 
      useMedicalHistory('other-patient-id'), {
        wrapper: ({ children }) => (
          <AuthProvider user={mockUnauthorizedUser}>
            {children}
          </AuthProvider>
        )
      }
    );
    
    await waitFor(() => {
      expect(result.current.error).toBeTruthy();
      expect(result.current.error?.message).toContain('Unauthorized');
    });
  });
});
```

### Configuraci√≥n de Testing
```javascript
// vitest.config.ts
export default defineConfig({
  test: {
    environment: 'jsdom',
    setupFiles: ['./src/test/setup.ts'],
    coverage: {
      reporter: ['text', 'json', 'html'],
      exclude: [
        'node_modules/',
        'src/test/',
        '**/*.d.ts',
        '**/*.config.*'
      ],
      thresholds: {
        global: {
          statements: 80,
          branches: 75,
          functions: 80,
          lines: 80
        },
        // Cobertura m√°s alta para m√≥dulos cr√≠ticos
        'src/features/auth/**': {
          statements: 95,
          branches: 90
        },
        'src/features/emergency/**': {
          statements: 95,
          branches: 95
        }
      }
    }
  }
});
```

## ‚ö†Ô∏è Manejo de Errores M√©dicos

### Error Boundaries Especializados
- **Medical Error Boundary**: Capturar errores en interfaces m√©dicas
- **Fallback UI informativo**: Mostrar informaci√≥n √∫til sin exponer datos
- **Error reporting**: Integraci√≥n con servicio de monitoreo m√©dico
- **Recovery mechanisms**: Recuperaci√≥n autom√°tica cuando sea posible

```typescript
// ‚úÖ Error Boundary m√©dico
class MedicalErrorBoundary extends Component<Props, State> {
  constructor(props: Props) {
    super(props);
    this.state = { hasError: false, errorInfo: null };
  }

  static getDerivedStateFromError(error: Error): State {
    return { hasError: true, errorInfo: error };
  }

  componentDidCatch(error: Error, errorInfo: ErrorInfo) {
    // Log cr√≠tico para errores m√©dicos
    logSecurityEvent('critical_medical_error', {
      error: error.message,
      componentStack: errorInfo.componentStack,
      userId: this.props.user?.id,
      patientId: this.props.currentPatient?.id,
      timestamp: new Date().toISOString(),
      severity: 'critical'
    });

    // Reportar a servicio de monitoreo
    if (process.env.NODE_ENV === 'production') {
      reportMedicalError(error, {
        user: this.props.user,
        context: 'medical_interface',
        additionalInfo: errorInfo
      });
    }
  }

  render() {
    if (this.state.hasError) {
      return (
        <div className="medical-error-fallback">
          <h2>Error en la aplicaci√≥n m√©dica</h2>
          <p>Se ha producido un error inesperado. El personal t√©cnico ha sido notificado.</p>
          <Button 
            onClick={() => window.location.reload()}
            variant="outline"
          >
            Recargar aplicaci√≥n
          </Button>
          {process.env.NODE_ENV === 'development' && (
            <details className="mt-4">
              <summary>Detalles del error (solo en desarrollo)</summary>
              <pre>{this.state.errorInfo?.message}</pre>
            </details>
          )}
        </div>
      );
    }

    return this.props.children;
  }
}
```

### Logging Estructurado para Auditor√≠a
```typescript
// ‚úÖ Logger m√©dico con niveles de auditor√≠a
interface MedicalLogEvent {
  eventType: 'access' | 'modification' | 'security' | 'emergency' | 'compliance';
  severity: 'info' | 'warning' | 'error' | 'critical';
  userId?: string;
  patientId?: string;
  resourceId?: string;
  action: string;
  metadata?: Record<string, any>;
  timestamp: string;
  ipAddress?: string;
  userAgent?: string;
}

class MedicalLogger {
  logMedicalEvent(event: MedicalLogEvent) {
    const enhancedEvent = {
      ...event,
      timestamp: new Date().toISOString(),
      sessionId: getCurrentSessionId(),
      environment: process.env.NODE_ENV
    };

    // Log local para desarrollo
    console.log(`[MEDICAL] ${event.severity.toUpperCase()}: ${event.action}`, enhancedEvent);

    // En producci√≥n, enviar a servicio de auditor√≠a
    if (process.env.NODE_ENV === 'production') {
      sendToAuditService(enhancedEvent);
    }

    // Para eventos cr√≠ticos, notificar inmediatamente
    if (event.severity === 'critical') {
      notifySecurityTeam(enhancedEvent);
    }
  }
}

export const medicalLogger = new MedicalLogger();
```

## üìà Performance y Escalabilidad M√©dica

### Next.js 15 Optimizations
- **Server Components**: Usar para datos m√©dicos no interactivos
- **Client Components**: Solo cuando necesite interactividad
- **Code splitting**: Lazy loading para dashboards especializados
- **Image optimization**: Optimizar im√°genes m√©dicas (rayos X, etc.)

```typescript
// ‚úÖ Code splitting por rol m√©dico
const DoctorDashboard = dynamic(() => import('@/features/doctor/DoctorDashboard'), {
  loading: () => <DashboardSkeleton role="doctor" />,
  ssr: false // Evitar hidration mismatch con datos sensibles
});

const PatientPortal = dynamic(() => import('@/features/patient/PatientPortal'), {
  loading: () => <PortalSkeleton role="patient" />
});

// ‚úÖ Server component para datos m√©dicos est√°ticos
async function MedicalRecordSummary({ patientId }: { patientId: string }) {
  const record = await getMedicalRecord(patientId); // Server-side fetch
  
  return (
    <div className="medical-summary">
      <h3>Resumen M√©dico</h3>
      {/* Render est√°tico de datos m√©dicos */}
    </div>
  );
}
```

### Database Performance
- **Indexes m√©dicos**: Optimizar consultas frecuentes
- **RLS optimization**: Pol√≠ticas eficientes sin N+1 queries
- **Connection pooling**: Gesti√≥n eficiente de conexiones
- **Query optimization**: Seleccionar solo campos necesarios

```sql
-- ‚úÖ Indexes espec√≠ficos para consultas m√©dicas
CREATE INDEX idx_medical_records_patient_date 
ON medical_records (patient_id, created_at DESC);

CREATE INDEX idx_appointments_doctor_date 
ON appointments (doctor_id, appointment_date) 
WHERE status = 'scheduled';

CREATE INDEX idx_emergency_contacts_patient 
ON emergency_contacts (patient_id) 
WHERE is_active = true;

-- ‚úÖ Funci√≥n RLS optimizada
CREATE OR REPLACE FUNCTION check_medical_access(
  user_id uuid,
  patient_id uuid,
  access_type text
)
RETURNS boolean
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public, extensions
AS $$
BEGIN
  -- Cach√© de verificaciones frecuentes
  RETURN EXISTS (
    SELECT 1 FROM user_permissions_cache 
    WHERE user_id = $1 
    AND patient_id = $2 
    AND access_type = $3
    AND expires_at > NOW()
  );
END;
$$;
```

## üöÄ Deployment y CI/CD M√©dico

### Vercel Configuration
```javascript
// vercel.json
{
  "functions": {
    "app/api/**": {
      "maxDuration": 30
    }
  },
  "headers": [
    {
      "source": "/(.*)",
      "headers": [
        {
          "key": "X-Content-Type-Options",
          "value": "nosniff"
        },
        {
          "key": "X-Frame-Options",
          "value": "DENY"
        },
        {
          "key": "Strict-Transport-Security",
          "value": "max-age=31536000; includeSubDomains"
        }
      ]
    }
  ]
}
```

### Environment Configuration
```bash
# .env.local.example
# SUPABASE CONFIGURATION (REQUIRED)
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key_here
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key_here

# MEDICAL COMPLIANCE
MEDICAL_AUDIT_ENDPOINT=https://audit.yourcompany.com
HIPAA_COMPLIANCE_MODE=true
ENCRYPTION_KEY=your_encryption_key_here

# ENVIRONMENT
NODE_ENV=production
NEXT_PUBLIC_SITE_URL=https://yourmedicalplatform.com

# SECURITY
RATE_LIMIT_ENABLED=true
SESSION_TIMEOUT_MINUTES=30
MAX_LOGIN_ATTEMPTS=3
```

## üìö Documentaci√≥n M√©dica

### Requisitos de Documentaci√≥n
- **Medical API Documentation**: Documentar endpoints m√©dicos con OpenAPI
- **Compliance Documentation**: Documentar medidas de compliance
- **Security Procedures**: Procedimientos de seguridad documentados
- **Emergency Protocols**: Protocolos de emergencia claros

### Comentarios JSDoc M√©dicos
```typescript
/**
 * Creates a new medical record with full audit trail
 * 
 * @param patientId - UUID of the patient (validated against permissions)
 * @param doctorId - UUID of the creating doctor
 * @param recordData - Medical record data (validated with Zod schema)
 * @returns Promise resolving to created medical record
 * 
 * @throws {UnauthorizedError} When doctor lacks permission to create records for patient
 * @throws {ValidationError} When medical data fails validation
 * @throws {ComplianceError} When action violates medical compliance rules
 * 
 * @compliance This function logs all creation attempts for HIPAA audit trail
 * @security Validates permissions before any database operation
 * 
 * @example
 * ```typescript
 * const record = await createMedicalRecord(
 *   'patient-uuid',
 *   'doctor-uuid',
 *   {
 *     diagnosis: 'Hypertension',
 *     treatment: 'ACE inhibitors',
 *     medications: [...],
 *     confidentialityLevel: 'restricted'
 *   }
 * );
 * ```
 */
async function createMedicalRecord(
  patientId: string,
  doctorId: string,
  recordData: MedicalRecordInput
): Promise<MedicalRecord> {
  // Implementation
}
```

## üîÑ Git Workflow M√©dico

### Conventional Commits para Aplicaciones M√©dicas
```bash
# Features m√©dicas
feat(auth): add emergency access override
feat(records): implement medical history encryption
feat(chat): add urgent message prioritization

# Bug fixes cr√≠ticos
fix(security): patch RLS vulnerability in patient data
fix(emergency): resolve contact notification failure
fix(compliance): fix audit trail logging

# Compliance y seguridad
compliance(hipaa): add patient data encryption
security(rls): strengthen medical record policies
audit(logging): enhance security event tracking

# Performance m√©dico
perf(db): optimize medical record queries
perf(ui): lazy load patient dashboard components
```

### Branch Protection Rules Elite
- **main/production**: Requiere review m√©dico + t√©cnico + security approval
- **staging**: Testing completo de compliance + performance validation
- **feature branches**: Nombrar con dominio m√©dico (`feature/medical-records-encryption`)
- **hotfix branches**: `hotfix/critical-security-patch` para emergencias
- **Automatic dependency updates**: Dependabot con security focus

### Git Hooks Automatizados
```bash
# ‚úÖ Pre-commit hook para calidad m√©dica
#!/bin/sh
# .git/hooks/pre-commit

echo "üè• Verificando calidad m√©dica antes del commit..."

# 1. Verificar l√≠mite de l√≠neas
echo "üìè Verificando l√≠mite de l√≠neas por archivo..."
files_over_limit=$(find src -name "*.ts" -o -name "*.tsx" | xargs wc -l | awk '$1 > 300 {print $2}')
if [ ! -z "$files_over_limit" ]; then
  echo "‚ùå Los siguientes archivos exceden 300 l√≠neas:"
  echo "$files_over_limit"
  exit 1
fi

# 2. Verificar datos m√©dicos hardcodeados
echo "üîí Verificando datos m√©dicos sensibles..."
if git diff --cached --name-only | xargs grep -l "V-[0-9]\{7,8\}\|E-[0-9]\{7,8\}" > /dev/null 2>&1; then
  echo "‚ùå Se detectaron posibles c√©dulas hardcodeadas"
  exit 1
fi

# 3. Verificar imports relativos largos
echo "üì¶ Verificando estructura de imports..."
long_imports=$(git diff --cached --name-only | xargs grep -l "\.\./\.\./\.\." 2>/dev/null || true)
if [ ! -z "$long_imports" ]; then
  echo "‚ö†Ô∏è Imports relativos muy largos detectados. Considerar usar alias de path."
fi

# 4. Ejecutar tests de archivos modificados
echo "üß™ Ejecutando tests relacionados..."
npm run test:changed

echo "‚úÖ Verificaciones de calidad m√©dica completadas"
```

## üìä Monitoreo y Observabilidad M√©dica

### M√©tricas de Sistema Cr√≠ticas
- **SLA m√©dicos**: 99.9% uptime para sistemas cr√≠ticos
- **Latencia objetivo**: < 200ms para operaciones m√©dicas cr√≠ticas
- **Error rate**: < 0.1% para operaciones m√©dicas
- **Alert thresholds**: Configurados para emergencias m√©dicas

```typescript
// ‚úÖ Sistema de monitoreo m√©dico avanzado
interface MedicalSystemMetrics {
  realTime: {
    activeUsers: number;
    concurrentMedicalSessions: number;
    emergencyAlertsActive: number;
    systemResponseTime: number;
  };
  medical: {
    appointmentsToday: number;
    criticalPatients: number;
    medicationAlertsActive: number;
    complianceViolations: number;
  };
  technical: {
    errorRate: number;
    memoryUsage: number;
    databaseConnections: number;
    queueSize: number;
  };
}

// ‚úÖ Alertas m√©dicas automatizadas
class MedicalAlertSystem {
  async checkCriticalMetrics(): Promise<void> {
    const metrics = await this.getSystemMetrics();
    
    // Alerta cr√≠tica: Error rate alto
    if (metrics.technical.errorRate > 0.5) {
      await this.triggerCriticalAlert({
        level: 'CRITICAL',
        message: 'High error rate detected in medical system',
        affectedServices: ['appointments', 'medical-records'],
        escalationPath: ['tech-lead', 'medical-director', 'cto']
      });
    }
    
    // Alerta m√©dica: Pacientes cr√≠ticos sin atenci√≥n
    if (metrics.medical.criticalPatients > 5) {
      await this.triggerMedicalAlert({
        level: 'URGENT',
        message: 'Multiple critical patients require immediate attention',
        notifyRoles: ['emergency-doctor', 'head-nurse', 'medical-director']
      });
    }
  }
}

// ‚úÖ Logging estructurado para an√°lisis
const medicalLogger = createLogger({
  level: 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.json()
  ),
  defaultMeta: { 
    service: 'platform-medicos',
    environment: process.env.NODE_ENV,
    version: process.env.APP_VERSION
  },
  transports: [
    new winston.transports.File({ 
      filename: 'logs/medical-error.log', 
      level: 'error',
      maxsize: 5242880, // 5MB
      maxFiles: 10
    }),
    new winston.transports.File({ 
      filename: 'logs/medical-audit.log',
      level: 'info',
      maxsize: 10485760, // 10MB
      maxFiles: 30
    })
  ]
});
```

### Dashboards de Observabilidad
```typescript
// ‚úÖ Dashboard m√©dico en tiempo real
const MedicalDashboard = () => {
  const { data: metrics, isLoading } = useRealTimeMetrics();
  const { data: alerts } = useActiveAlerts();
  
  return (
    <div className="medical-dashboard">
      <MetricCard
        title="Pacientes Activos"
        value={metrics?.activePatients}
        trend={metrics?.patientTrend}
        threshold={{ warning: 100, critical: 150 }}
      />
      
      <MetricCard
        title="Tiempo Respuesta Sistema"
        value={`${metrics?.responseTime}ms`}
        trend={metrics?.responseTrend}
        threshold={{ warning: 500, critical: 1000 }}
      />
      
      <AlertPanel
        alerts={alerts}
        onAcknowledge={handleAlertAcknowledge}
        onEscalate={handleAlertEscalate}
      />
      
      <SystemHealthIndicator
        services={metrics?.serviceHealth}
        overallHealth={metrics?.overallHealthScore}
      />
    </div>
  );
};
```

## üìö Documentaci√≥n Elite y Est√°ndares

### Documentaci√≥n Living (Auto-generada)
- **API Documentation**: OpenAPI 3.0 con ejemplos m√©dicos reales
- **Component Documentation**: Storybook con casos de uso m√©dicos
- **Architecture Decision Records**: Para decisiones cr√≠ticas m√©dicas
- **Security Documentation**: Procedimientos de seguridad actualizados
- **Compliance Documentation**: Auditor√≠as y certificaciones

```typescript
// ‚úÖ Documentaci√≥n autom√°tica de APIs m√©dicas
/**
 * @openapi
 * /api/medical-records:
 *   post:
 *     summary: Create medical record
 *     description: Creates a new medical record with full audit trail and permission validation
 *     tags: [Medical Records]
 *     security:
 *       - BearerAuth: []
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             $ref: '#/components/schemas/MedicalRecordInput'
 *           examples:
 *             routine_checkup:
 *               summary: Routine medical checkup
 *               value:
 *                 patientId: "550e8400-e29b-41d4-a716-446655440000"
 *                 diagnosis: "Routine annual physical examination"
 *                 treatment: "Continue current medication regimen"
 *                 confidentialityLevel: "restricted"
 *             emergency_record:
 *               summary: Emergency medical record
 *               value:
 *                 patientId: "550e8400-e29b-41d4-a716-446655440001"
 *                 diagnosis: "Acute myocardial infarction"
 *                 treatment: "Emergency cardiac intervention required"
 *                 confidentialityLevel: "confidential"
 *                 emergencyAccess: true
 *     responses:
 *       201:
 *         description: Medical record created successfully
 *         content:
 *           application/json:
 *             schema:
 *               $ref: '#/components/schemas/MedicalRecord'
 *       401:
 *         $ref: '#/components/responses/Unauthorized'
 *       403:
 *         $ref: '#/components/responses/InsufficientPermissions'
 *       422:
 *         $ref: '#/components/responses/ValidationError'
 */
```

## ‚úÖ Checklist de Compliance M√©dico Elite

### Antes de cada PR (Pull Request):
- [ ] **Arquitectura y Responsabilidad**
  - [ ] Archivo no supera 300 l√≠neas (ESTRICTO)
  - [ ] Una sola responsabilidad por archivo verificada
  - [ ] Principios SOLID aplicados correctamente
  - [ ] Dependency Injection implementada donde corresponde
  - [ ] Separaci√≥n de capas (Domain, Application, Infrastructure) respetada
  
- [ ] **TypeScript Elite**
  - [ ] Tipos expl√≠citos para todos los datos m√©dicos
  - [ ] Branded types usados para IDs m√©dicos
  - [ ] Union types discriminados para estados complejos
  - [ ] Template literal types para formatos espec√≠ficos
  - [ ] Utility types para transformaciones seguras
  
- [ ] **Seguridad M√©dica**
  - [ ] No hay datos m√©dicos hardcodeados (c√©dulas, historiales, etc.)
  - [ ] RLS policies verificadas para nuevas tablas
  - [ ] Permisos granulares validados por rol m√©dico
  - [ ] Audit trail implementado para cambios cr√≠ticos
  - [ ] Encriptaci√≥n aplicada a datos sensibles
  - [ ] Rate limiting configurado para endpoints cr√≠ticos
  
- [ ] **Validaciones Zod Avanzadas**
  - [ ] Schemas con validaciones m√©dicas espec√≠ficas
  - [ ] Transformaciones autom√°ticas implementadas
  - [ ] Validaciones condicionales por rol m√©dico
  - [ ] Error messages informativos en espa√±ol
  
- [ ] **Testing de Clase Mundial**
  - [ ] Tests unitarios para funciones m√©dicas cr√≠ticas
  - [ ] Property-based testing para validaciones complejas
  - [ ] Tests de seguridad para nuevos permisos
  - [ ] Tests de accessibility WCAG 2.1 AA
  - [ ] Tests de performance para componentes cr√≠ticos
  - [ ] Cobertura m√≠nima 80% (95% para m√≥dulos cr√≠ticos)
  
- [ ] **Performance y Escalabilidad**
  - [ ] Lazy loading implementado correctamente
  - [ ] Memoizaci√≥n selectiva aplicada
  - [ ] Queries optimizadas sin N+1 problems
  - [ ] Code splitting por roles m√©dicos
  - [ ] Bundle size impacto minimizado (< 5KB por componente)
  
- [ ] **Compliance HIPAA**
  - [ ] Documentaci√≥n m√©dica actualizada
  - [ ] Variables de entorno configuradas securely
  - [ ] Migraciones de BD aplicadas y verificadas
  - [ ] Logging de seguridad implementado
  - [ ] M√©tricas de monitoreo configuradas
  - [ ] Alertas m√©dicas automatizadas activadas

### Antes de deployment a producci√≥n:
- [ ] **Medical Compliance Verification**
  - [ ] HIPAA compliance checklist completado
  - [ ] Audit trail funcionando correctamente
  - [ ] Backup y recovery procedures verificados
  - [ ] Security monitoring configurado
- [ ] **Performance Validation**
  - [ ] Load testing en endpoints m√©dicos cr√≠ticos
  - [ ] Database performance verified
  - [ ] CDN configurado para assets m√©dicos
- [ ] **Security Final Check**
  - [ ] Penetration testing completado
  - [ ] SSL/TLS certificados v√°lidos
  - [ ] Environment variables seguras
  - [ ] Rate limiting configurado

---

## üö® RECORDATORIOS CR√çTICOS ELITE

> **‚ö†Ô∏è DATOS M√âDICOS SENSIBLES**: Esta aplicaci√≥n maneja informaci√≥n m√©dica protegida clase mundial. Cada l√≠nea de c√≥digo debe considerar la privacidad y seguridad del paciente con m√°xima rigurosidad.

> **üîí COMPLIANCE OBLIGATORIO**: El incumplimiento de estas reglas puede resultar en violaciones de compliance m√©dico, riesgos legales y p√©rdida de certificaciones. Son NO NEGOCIABLES.

> **üìä AUDIT TRAIL TOTAL**: Todas las operaciones cr√≠ticas deben ser registradas para auditor√≠a m√©dica. Sistema de trazabilidad completo obligatorio.

> **üöÄ PERFORMANCE CR√çTICO**: En emergencias m√©dicas, cada segundo cuenta. El c√≥digo debe ser eficiente, robusto y escalable para manejar picos de demanda.

> **üèóÔ∏è ARQUITECTURA LIMPIA**: La responsabilidad √∫nica y la separaci√≥n de capas son fundamentales para el mantenimiento a largo plazo de una plataforma m√©dica cr√≠tica.

> **üß™ TESTING OBLIGATORIO**: Sin tests comprehensivos, NO HAY DEPLOYMENT. La vida de los pacientes puede depender de la confiabilidad del c√≥digo.

> **üìà MONITOREO CONTINUO**: Sistema de observabilidad 24/7 para detectar problemas antes de que afecten a pacientes o personal m√©dico.

---

## üèÜ M√©tricas de Excelencia (KPIs de Calidad)

### Objetivos T√©cnicos Elite
- **Code Quality Score**: > 95/100
- **Test Coverage**: > 90% (99% en m√≥dulos cr√≠ticos)
- **Performance**: < 200ms respuesta promedio
- **Security Score**: 100/100 (sin vulnerabilidades)
- **Uptime**: 99.99% para servicios cr√≠ticos
- **Documentation Coverage**: 100% APIs p√∫blicas

### M√©tricas de Refactorizaci√≥n Continua
- **Files > 300 lines**: 0 (tolerancia absoluta cero)
- **Cyclomatic Complexity**: < 10 por funci√≥n
- **Duplicate Code**: < 1%
- **Technical Debt**: < 5% del tiempo total
- **Dependency Freshness**: < 30 d√≠as desactualizaci√≥n

---

## üéñÔ∏è Certificaci√≥n de Desarrollador M√©dico

Para trabajar en Platform M√©dicos, cada desarrollador debe:

1. **‚úÖ Dominar estas reglas completamente**
2. **‚úÖ Pasar auditor√≠a de c√≥digo m√©dico**
3. **‚úÖ Completar training en compliance HIPAA**
4. **‚úÖ Demostrar expertise en arquitectura limpia**
5. **‚úÖ Aprobar simulacro de emergencia m√©dica t√©cnica**

---

**üè• THESE RULES SAVE LIVES. NO EXCEPTIONS. NO SHORTCUTS. MEDICAL EXCELLENCE THROUGH CODE EXCELLENCE.**

**Estas reglas son obligatorias para mantener la integridad, seguridad y compliance de la plataforma m√©dica de clase mundial. Cada desarrollador debe familiarizarse y aplicar estas pr√°cticas consistentemente. La excelencia m√©dica se logra a trav√©s de la excelencia en el c√≥digo.**